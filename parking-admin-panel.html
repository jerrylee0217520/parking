<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 停車管理中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }
  </style>
</head>
<body class="antialiased p-4">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg mt-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">佳元松江社區 停車管理中心</h1>
    <p class="text-gray-600 text-center mb-6">手動管理停車記錄</p>
    
    <div id="loading" class="text-center text-gray-500 hidden">
      <div class="flex justify-center items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>載入中...</span>
      </div>
    </div>

    <div id="error-message" class="text-red-500 text-center mb-4 hidden"></div>

    <div id="content">
      <div class="mb-6 border p-4 rounded-xl shadow-inner bg-gray-50">
        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">新增停車記錄</h2>
        <div class="space-y-4">
          <div>
            <label for="carPlate" class="block text-sm font-medium text-gray-700">車牌號碼:</label>
            <input type="text" id="carPlate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
          </div>
          <div>
            <label for="huBei" class="block text-sm font-medium text-gray-700">戶別:</label>
            <input type="text" id="huBei" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
          </div>
          <button id="addRecordBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">新增停車</button>
        </div>
      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">當前停車列表</h2>
        <div id="parking-list" class="space-y-4">
          <!-- Parking records will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
      apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
      authDomain: "jy-2025.firebaseapp.com",
      projectId: "jy-2025",
      storageBucket: "jy-2025.firebasestorage.app",
      messagingSenderId: "640527461851",
      appId: "1:640527461851:web:eed9f82d698275371fcbfe",
      measurementId: "G-HVEVMTSR9L"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId;
    const collectionPath = `/artifacts/${appId}/public/data/parking-records`;

    const carPlateInput = document.getElementById('carPlate');
    const huBeiInput = document.getElementById('huBei');
    const addRecordBtn = document.getElementById('addRecordBtn');
    const parkingList = document.getElementById('parking-list');
    const loadingEl = document.getElementById('loading');
    const errorMessageEl = document.getElementById('error-message');

    function showLoading(show) {
      loadingEl.classList.toggle('hidden', !show);
      document.getElementById('content').classList.toggle('hidden', show);
    }

    function showError(message) {
      errorMessageEl.textContent = message;
      errorMessageEl.classList.remove('hidden');
    }

    function hideError() {
      errorMessageEl.classList.add('hidden');
    }

    async function initializeAppAndAuth() {
      showLoading(true);
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            setupRealtimeListener();
          } else {
            console.error('User not signed in.');
            showError('無法驗證使用者。');
          }
        });
      } catch (e) {
        console.error("Initialization failed:", e);
        showError("應用程式初始化失敗，請檢查網路連線。");
        showLoading(false);
      }
    }

    function setupRealtimeListener() {
      try {
        const collectionRef = collection(db, collectionPath);
        onSnapshot(collectionRef, (snapshot) => {
          const records = [];
          snapshot.forEach(doc => {
            records.push({ id: doc.id, ...doc.data() });
          });
          renderParkingList(records);
          showLoading(false);
        }, (error) => {
          console.error("Failed to listen to Firestore:", error);
          showError("無法即時更新停車記錄。");
          showLoading(false);
        });
      } catch (e) {
        console.error("Failed to set up Firestore listener:", e);
        showError("設定數據監聽失敗。");
        showLoading(false);
      }
    }

    function renderParkingList(records) {
      parkingList.innerHTML = '';
      if (records.length === 0) {
        parkingList.innerHTML = `<p class="text-gray-500 text-center">目前沒有停車記錄。</p>`;
        return;
      }
      records.forEach(record => {
        const recordEl = document.createElement('div');
        recordEl.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm';
        recordEl.innerHTML = `
          <div>
            <p class="font-bold text-gray-800">${record.carPlate}</p>
            <p class="text-sm text-gray-600">${record.huBei}</p>
          </div>
          <button data-id="${record.id}" class="delete-btn text-red-500 hover:text-red-700 transition duration-150">
            刪除
          </button>
        `;
        parkingList.appendChild(recordEl);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteRecord(btn.dataset.id));
      });
    }

    async function addRecord() {
      const carPlate = carPlateInput.value.trim();
      const huBei = huBeiInput.value.trim();

      if (!carPlate || !huBei) {
        showError('車牌號碼和戶別不能為空。');
        return;
      }
      hideError();

      try {
        const docRef = doc(collection(db, collectionPath));
        await setDoc(docRef, {
          carPlate,
          huBei,
          timestamp: new Date().toISOString()
        });
        carPlateInput.value = '';
        huBeiInput.value = '';
      } catch (e) {
        console.error("Failed to add record:", e);
        showError("新增記錄失敗。請重試。");
      }
    }

    async function deleteRecord(id) {
      try {
        const docRef = doc(db, collectionPath, id);
        await deleteDoc(docRef);
      } catch (e) {
        console.error("Failed to delete record:", e);
        showError("刪除記錄失敗。請重試。");
      }
    }

    addRecordBtn.addEventListener('click', addRecord);
    window.addEventListener('DOMContentLoaded', initializeAppAndAuth);
  </script>
</body>
</html>