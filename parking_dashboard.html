<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 一樓臨時停車位即時狀態</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1.25rem;
      width: 95%;
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .spot {
      position: relative;
      padding-top: 100%; /* Maintain 1:1 ratio */
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease-in-out;
      cursor: default;
    }
    
    .spot:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .spot-inner {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      padding: 0.5rem;
      text-align: center;
      transition: background 0.5s ease;
    }
    
    .spot-number {
        font-size: clamp(1.8rem, 8vw, 2.5rem);
        font-weight: bold;
    }

    /* Status gradients and animations */
    .status-available { 
      background: linear-gradient(45deg, #66bb6a, #43a047); 
    }
    .status-occupied-owner { /* Owner with parking space */
      background: linear-gradient(45deg, #42a5f5, #1e88e5); 
    }
    .status-occupied-temp { /* Visitor/Owner without space */
      background: linear-gradient(45deg, #ef5350, #d32f2f); 
      animation: occupiedPulse 2.5s infinite ease-in-out;
    }
    .status-occupied-construction { /* Construction */
      background: linear-gradient(45deg, #ffca28, #ffb300);
    }
    .status-occupied-vip { /* VIP Guest */
      background: linear-gradient(45deg, #a78bfa, #8b5cf6);
    }
    
    @keyframes occupiedPulse {
        0%, 100% { box-shadow: 0 4px 15px rgba(239, 83, 80, 0.2); }
        50% { box-shadow: 0 8px 25px rgba(239, 83, 80, 0.4); }
    }

    .spot.refreshing {
        animation: spotRefresh 0.8s ease-in-out;
    }
    @keyframes spotRefresh {
        0% { transform: scale(1); }
        50% { transform: scale(1.05) rotate(3deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    .spot-status {
      font-size: clamp(0.75rem, 3vw, 0.9rem);
      font-weight: normal;
      margin-top: 0.25rem;
    }
    .car-info {
        font-size: clamp(0.8rem, 3.5vw, 1rem);
        font-weight: bold;
        margin-top: 0.25rem;
        line-height: 1.3;
        width: 100%;
    }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4">
    <div class="text-center my-4">
      <h1 id="dashboardTitle" class="text-2xl sm:text-3xl font-bold text-gray-800">佳元松江社區 臨停車位儀表板</h1>
      <p id="lastUpdated" class="text-sm sm:text-base text-gray-500 mt-2">-</p>
    </div>
    
    <div id="loading" class="text-center text-gray-500 mt-20">
      <div class="flex flex-col items-center justify-center">
        <svg class="animate-spin h-8 w-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="mt-4">正在從雲端同步資料...</span>
      </div>
    </div>

    <div id="content" class="hidden">
      <div class="grid" id="parkingGrid">
        <div class="spot" data-spot-id="01"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="02"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="03"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="04"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="05"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="06"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="07"><div class="spot-inner"></div></div>
      </div>
    </div>
  </div>
  <footer class="text-center text-gray-500 text-sm my-8">
    © 佳元松江-管理中心 2025
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      // --- Settings ---
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      let firebaseConfig;
      let useTokenAuth = false;

      if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        firebaseConfig = JSON.parse(__firebase_config);
        useTokenAuth = true;
      } else {
        console.warn("Firebase config not detected, using fallback.");
        firebaseConfig = {
            apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
            authDomain: "jy-2025.firebaseapp.com",
            projectId: "jy-2025",
            storageBucket: "jy-2025.appspot.com",
            messagingSenderId: "640527461851",
            appId: "1:640527461851:web:eed9f82d698275371fcbfe",
            measurementId: "G-HVEVMTSR9L"
        };
      }
      
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      const collectionPath = `/artifacts/${appId}/public/data/parking-records`;
      const TOTAL_SPOTS = 7;

      // --- Resident Data ---
      const residentParkingMap = new Map([
        ['10B-10樓', 'B2-05'], ['9A-9樓', 'B2/13'], ['9B-9樓', 'B2-09'],
        ['8A-8樓', 'B2/08'], ['7A-7樓', 'B2/01'], ['6B-6樓', 'B2-06'],
        ['6D-6樓', 'B2-02'], ['5C-5樓', 'B2-14'], ['5E-5樓', 'B2-07'],
        ['4B-4樓', 'B2-03'], ['4EF-4樓', 'B2-04'], ['3CD-3樓', 'B2-10'],
        ['1A-1樓', 'B2/11'], ['1B-1樓', 'B2-12']
      ]);

      // --- DOM Elements ---
      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');
      const titleEl = document.getElementById('dashboardTitle');
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const parkingSpots = document.querySelectorAll('.spot');

      // --- App Logic ---
      let db, auth;

      function renderParking(records) {
        const occupiedCount = records.length;
        const availableCount = TOTAL_SPOTS - occupiedCount;
        
        titleEl.textContent = `臨停車位儀表板 (尚有 ${availableCount} 空位)`;
        const now = new Date();
        lastUpdatedEl.textContent = `最後更新: ${now.toLocaleTimeString('zh-TW')}`;

        parkingSpots.forEach((spotDiv, index) => {
          const spotNumber = index + 1;
          const innerDiv = spotDiv.querySelector('.spot-inner');
          let newClassName = 'spot ';
          let newHtml = '';

          if (spotNumber <= occupiedCount) {
            const car = records[index];
            const huBeiUpper = car.huBei ? car.huBei.toUpperCase() : '';
            const isConstruction = huBeiUpper.includes('施工');
            const isVip = huBeiUpper === '貴賓' || huBeiUpper === 'VIP';
            const isOwnerWithSpot = residentParkingMap.has(car.huBei);

            if (isVip) {
                newClassName += 'status-occupied-vip';
            } else if (isConstruction) {
                newClassName += 'status-occupied-construction';
            } else if (isOwnerWithSpot) {
                newClassName += 'status-occupied-owner';
            } else {
                newClassName += 'status-occupied-temp';
            }
            
            newHtml = `<div class="spot-number">${String(spotNumber).padStart(2, '0')}</div>
                       <div class="spot-status">已停車</div>
                       <div class="car-info">${car.carPlate || ''}<br>${car.huBei || ''}</div>`;
          } else {
            newClassName += 'status-available';
            newHtml = `<div class="spot-number">${String(spotNumber).padStart(2, '0')}</div>
                       <div class="spot-status">可停</div>`;
          }

          if (spotDiv.className !== newClassName) {
            spotDiv.className = newClassName;
          }
          if (innerDiv.innerHTML !== newHtml) {
            innerDiv.innerHTML = newHtml;
          }
          
          spotDiv.classList.add('refreshing');
          setTimeout(() => spotDiv.classList.remove('refreshing'), 800);
        });

        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
      }

      async function initializeAppAndAuth() {
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (useTokenAuth && initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          onAuthStateChanged(auth, (user) => {
            if (user) {
              setupRealtimeListener();
            } else {
              console.error('Firebase: User not signed in.');
            }
          });
        } catch (e) {
          console.error("Firebase initialization failed:", e);
        }
      }

      function setupRealtimeListener() {
        try {
          const collectionRef = collection(db, collectionPath);
          const q = query(collectionRef);

          onSnapshot(q, (snapshot) => {
            let records = snapshot.docs
              .map(doc => ({ id: doc.id, ...doc.data() }))
              .filter(record => !record.leaveTime); 
            
            records.sort((a, b) => (a.entryTime?.seconds || 0) - (b.entryTime?.seconds || 0));
            
            renderParking(records);
          }, (error) => {
            console.error("Firestore data listener failed:", error);
          });
        } catch (e) {
          console.error("Failed to set up Firestore listener:", e);
        }
      }

      initializeAppAndAuth();
    });
  </script>
</body>
</html>