<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 一樓臨時停車位即時狀態</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 自定義滾動條樣式 */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 1rem;
      width: 95%;
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .spot {
      position: relative;
      padding-top: 100%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease-in-out;
      cursor: default;
    }
    
    .spot:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .spot-inner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      padding: 0.5rem;
      text-align: center;
    }
    
    .spot-number {
        font-size: 1.75rem;
        font-weight: bold;
    }

    /* 各種狀態的漸層和動畫 */
    .status-available { 
      background: linear-gradient(45deg, #66bb6a, #43a047); 
    }
    
    .status-occupied-owner { /* 有買車位的屋主 */
      background: linear-gradient(45deg, #42a5f5, #1e88e5); 
    }
    
    .status-occupied-temp { /* 沒有買車位的屋主 */
      background: linear-gradient(45deg, #ef5350, #d32f2f); 
      animation: occupiedPulse 2.5s infinite ease-in-out;
    }

    .status-occupied-construction { /* 施工臨停 */
      background: linear-gradient(45deg, #ffca28, #ffb300);
    }
    
    @keyframes occupiedPulse {
        0%, 100% { box-shadow: 0 4px 15px rgba(239, 83, 80, 0.2); }
        50% { box-shadow: 0 8px 25px rgba(239, 83, 80, 0.4); }
    }

    #refresh {
      display: block;
      margin: 1.5rem auto;
      padding: 0.75rem 1.5rem;
      font-size: 1.1rem;
      background: #2E5540;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(46,85,64,0.3);
      transition: all 0.3s ease;
    }

    #refresh:active {
        transform: translateY(1px);
        box-shadow: 0 2px 10px rgba(46,85,64,0.4);
    }
    
    .spot.refreshing {
        animation: spotRefresh 0.8s ease-in-out;
    }
    @keyframes spotRefresh {
        0% { transform: scale(1); }
        50% { transform: scale(1.05) rotate(5deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    .spot-status {
      font-size: 0.8rem;
      font-weight: normal;
      margin-top: 0.25rem;
    }
    .car-info {
        font-size: 1rem;
        font-weight: bold;
        margin-top: 0.25rem;
        line-height: 1.3;
        width: 100%;
    }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4">
    <h1 id="dashboardTitle" class="text-3xl font-bold text-center text-gray-800 my-4">佳元松江社區 一樓臨時停車位儀表板</h1>
    <div class="grid" id="parkingGrid"></div>
    <div class="flex flex-col sm:flex-row justify-center mt-4 space-y-2 sm:space-y-0 sm:space-x-4">
        <button id="refresh">刷新停車狀態</button>
    </div>
  </div>
  <footer class="text-center text-gray-500 text-sm mt-8">
    © 佳元松江-管理中心2025
  </footer>
  <script>
    const remoteCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZtav6tP67x1gPyFeRo_lyok--bE1VHCxs-_W5DNnytDdexun_k-c48ZNLrmoUmRX_BK-vtVksXYC8/pub?output=csv";

    // 內嵌住戶車位清單 CSV 數據
    const residentParkingCsvData = `戶別,所有權人,車位
10A-10樓,蔡政隆,無車位
10B-10樓,梁本郁,B2-05
9A-9樓,黃雅玲,B2/13
9B-9樓,張美華,B2-09
8A-8樓,黃誼僑,B2/08
8B-8樓,佘雪紅,無車位
7A-7樓,魏均穎,B2/01
7B-7樓,尹衍嵐,無車位
7C-7樓,黃怡瑋,無車位
7D-7樓,李佳芳,無車位
7E-7樓,王楷皓,無車位
7F-7樓,游斯涵,無車位
6A-6樓,李苾琳,無車位
6B-6樓,莊春陽,B2-06
6C-6樓,蘇傳欽,無車位
6D-6樓,黃薇芝,B2-02
6E-6樓,兒玉勝行,無車位
6F-6樓,陳品妤,無車位
5A-5樓,仇沛珊,無車位
5B-5樓,優舍室內裝修,無車位
5C-5樓,王子嫣,B2-14
5D-5樓,張甄庭,無車位
5E-5樓,劉禹秀,B2-07
5F-5樓,楊淑如,無車位
4A-4樓,蕭承昕,無車位
4B-4樓,鄭美蘭,B2-03
4CD-4樓,張雅婷,無車位
4EF-4樓,李宛儒,B2-04
3A-3樓,張儷瑭,無車位
3B-3樓,張儷瑋,無車位
3CD-3樓,杜啓斌,B2-10
3EF-3樓,高慧雯,無車位
2A-2樓,許郅玫,無車位
2B-2樓,湯蕙如,無車位
2C-2樓,黃翎鈞,無車位
2D-2樓,郭純純,無車位
2E-2樓,林梓聖,無車位
2F-2樓,魏慶龍,無車位
1A-1樓,之餘國際室內裝修工程有限公司,B2/11
1B-1樓,之餘國際室內裝修工程有限公司,B2-12
`;

    function renderParking(parkingCsvData) {
      const grid = document.getElementById('parkingGrid');
      
      const spots = document.querySelectorAll('.spot');
      if (spots.length > 0) {
        spots.forEach(spot => spot.classList.add('refreshing'));
      }
      
      setTimeout(() => {
        grid.innerHTML = '';
        
        const lines = parkingCsvData.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) {
            spots.forEach(spot => spot.classList.remove('refreshing'));
            return;
        }

        const headers = lines[0].split(',').map(h => h.trim());
        const dataRows = lines.slice(1);

        const getIndex = (name) => headers.indexOf(name);
        
        const allParkingInfo = dataRows.map(row => row.split(','))
          .map(values => {
              const rowData = {};
              headers.forEach((header, index) => {
                  rowData[header] = values[index]?.trim();
              });
              return rowData;
          });

        const residentParkingLines = residentParkingCsvData.split(/\r?\n/).slice(1).filter(line => line.trim() !== '');
        const residentParkingMap = residentParkingLines.reduce((acc, line) => {
            const values = line.split(',');
            const huBei = values[0]?.trim();
            const carSpot = values[2]?.trim();
            if (huBei && carSpot && carSpot !== '無車位') {
                acc[huBei] = carSpot;
            }
            return acc;
        }, {});

        const carsInParking = allParkingInfo.filter(car => car['停放時間'] && !car['離開時間']);

        const firstDate = allParkingInfo[0]['日期']?.trim();
        let formattedDate = firstDate;
        if (firstDate) {
          formattedDate = firstDate.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})/, '$1-$2-$3')
                                   .replace(/(\d{2,4})年(\d{1,2})月(\d{1,2})日/, '$1-$2-$3');
        }
        document.getElementById('dashboardTitle').textContent = `佳元松江社區 一樓臨時停車位儀表板 (${formattedDate})`;
        
        const occupiedCount = carsInParking.length;
        for (let i = 1; i <= 7; i++) {
          const id = String(i).padStart(2, '0');
          const isOccupied = i <= occupiedCount;
          
          let spotDiv = document.createElement('div');
          let innerDiv = document.createElement('div');

          if (isOccupied) {
              const car = carsInParking[i - 1];
              let isConstruction = car['戶別'] && car['戶別'].includes('施工');
              let isOwnerWithSpot = !!residentParkingMap[car['戶別']];

              if (isConstruction) {
                  spotDiv.className = 'spot status-occupied-construction';
              } else if (isOwnerWithSpot) {
                  spotDiv.className = 'spot status-occupied-owner';
              } else {
                  spotDiv.className = 'spot status-occupied-temp';
              }

              innerDiv.className = 'spot-inner';
              let spotHtml = `<div class="spot-number">${id}</div>`;
              spotHtml += `<div class="spot-status">已停車</div>`;
              spotHtml += `<div class="car-info">${car['車牌號碼']}<br>${car['戶別']}</div>`;
              innerDiv.innerHTML = spotHtml;
          } else {
              spotDiv.className = 'spot status-available';
              innerDiv.className = 'spot-inner';
              let spotHtml = `<div class="spot-number">${id}</div>`;
              spotHtml += `<div class="spot-status">可停</div>`;
              innerDiv.innerHTML = spotHtml;
          }

          spotDiv.appendChild(innerDiv);
          grid.appendChild(spotDiv);
        }
        
      }, 500);
    }

    async function fetchAndRenderData(url) {
        try {
            const grid = document.getElementById('parkingGrid');
            grid.innerHTML = `<p class="text-center col-span-full">正在載入遠端數據...</p>`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.text();
            renderParking(data);
        } catch (error) {
            console.error("無法載入遠端 CSV 檔案:", error);
            const grid = document.getElementById('parkingGrid');
            grid.innerHTML = `<p class="text-red-500 text-center col-span-full">載入數據失敗。請檢查網址、檔案編碼或網路連線。</p>`;
        }
    }

    document.getElementById('refresh').addEventListener('click', () => fetchAndRenderData(remoteCsvUrl));
    window.addEventListener('DOMContentLoaded', () => fetchAndRenderData(remoteCsvUrl));
    
    // 每 30 秒自動刷新一次數據
    setInterval(() => {
      fetchAndRenderData(remoteCsvUrl);
    }, 30000);
  </script>
</body>
</html>