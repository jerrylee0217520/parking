<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 一樓臨時停車位即時狀態</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 自定義滾動條樣式 */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.25rem;
      width: 95%;
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .spot {
      position: relative;
      padding-top: 100%; /* 維持 1:1 比例 */
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease-in-out;
      cursor: default;
    }
    
    .spot:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .spot-inner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      padding: 0.5rem;
      text-align: center;
      transition: background 0.5s ease;
    }
    
    .spot-number {
        font-size: 1.8rem;
        font-weight: bold;
    }

    /* 各種狀態的漸層和動畫 */
    .status-available { 
      background: linear-gradient(45deg, #66bb6a, #43a047); 
    }
    
    .status-occupied-owner { /* 有買車位的屋主 */
      background: linear-gradient(45deg, #42a5f5, #1e88e5); 
    }
    
    .status-occupied-temp { /* 沒有買車位的屋主 */
      background: linear-gradient(45deg, #ef5350, #d32f2f); 
      animation: occupiedPulse 2.5s infinite ease-in-out;
    }

    .status-occupied-construction { /* 施工臨停 */
      background: linear-gradient(45deg, #ffca28, #ffb300);
    }
    
    @keyframes occupiedPulse {
        0%, 100% { box-shadow: 0 4px 15px rgba(239, 83, 80, 0.2); }
        50% { box-shadow: 0 8px 25px rgba(239, 83, 80, 0.4); }
    }

    .spot.refreshing {
        animation: spotRefresh 0.8s ease-in-out;
    }
    @keyframes spotRefresh {
        0% { transform: scale(1); }
        50% { transform: scale(1.05) rotate(3deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    .spot-status {
      font-size: 0.8rem;
      font-weight: normal;
      margin-top: 0.25rem;
    }
    .car-info {
        font-size: 1rem;
        font-weight: bold;
        margin-top: 0.25rem;
        line-height: 1.3;
        width: 100%;
    }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4">
    <div class="text-center my-4">
      <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-800">佳元松江社區 臨停車位儀表板</h1>
      <p id="lastUpdated" class="text-sm text-gray-500 mt-2">-</p>
    </div>
    
    <div id="loading" class="text-center text-gray-500 mt-20">
      <div class="flex flex-col items-center justify-center">
        <svg class="animate-spin h-8 w-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="mt-4">正在從雲端同步資料...</span>
      </div>
    </div>

    <div id="content" class="hidden">
      <!-- 預先建立 7 個停車格的結構 -->
      <div class="grid" id="parkingGrid">
        <div class="spot" data-spot-id="01"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="02"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="03"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="04"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="05"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="06"><div class="spot-inner"></div></div>
        <div class="spot" data-spot-id="07"><div class="spot-inner"></div></div>
      </div>
    </div>
  </div>
  <footer class="text-center text-gray-500 text-sm my-8">
    © 佳元松江-管理中心 2025
  </footer>

  <script type="module">
    // Firebase 相關設定 - import 必須在模組的最頂層
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 確保 DOM 完全載入後再執行腳本
    document.addEventListener('DOMContentLoaded', () => {
      // --- 設定 ---
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      
      // *** FIX: 使用環境提供的 Firebase 設定，而不是寫死的設定 ***
      if (typeof __firebase_config === 'undefined') {
        const loadingDiv = document.getElementById('loading');
        loadingDiv.textContent = '錯誤：Firebase 設定檔遺失，無法初始化應用程式。';
        console.error('Firebase config is not available.');
        return; // 如果缺少設定，則停止執行
      }
      const firebaseConfig = JSON.parse(__firebase_config);
      
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      const collectionPath = `/artifacts/${appId}/public/data/parking-records`;
      const TOTAL_SPOTS = 7;

      // --- 住戶車位資料 ---
      const residentParkingCsvData = `戶別,所有權人,車位
      10A-10樓,蔡政隆,無車位
      10B-10樓,梁本郁,B2-05
      9A-9樓,黃雅玲,B2/13
      9B-9樓,張美華,B2-09
      8A-8樓,黃誼僑,B2/08
      8B-8樓,佘雪紅,無車位
      7A-7樓,魏均穎,B2/01
      7B-7樓,尹衍嵐,無車位
      7C-7樓,黃怡瑋,無車位
      7D-7樓,李佳芳,無車位
      7E-7樓,王楷皓,無車位
      7F-7樓,游斯涵,無車位
      6A-6樓,李苾琳,無車位
      6B-6樓,莊春陽,B2-06
      6C-6樓,蘇傳欽,無車位
      6D-6樓,黃薇芝,B2-02
      6E-6樓,兒玉勝行,無車位
      6F-6樓,陳品妤,無車位
      5A-5樓,仇沛珊,無車位
      5B-5樓,優舍室內裝修,無車位
      5C-5樓,王子嫣,B2-14
      5D-5樓,張甄庭,無車位
      5E-5樓,劉禹秀,B2-07
      5F-5樓,楊淑如,無車位
      4A-4樓,蕭承昕,無車位
      4B-4樓,鄭美蘭,B2-03
      4CD-4樓,張雅婷,無車位
      4EF-4樓,李宛儒,B2-04
      3A-3樓,張儷瑭,無車位
      3B-3樓,張儷瑋,無車位
      3CD-3樓,杜啓斌,B2-10
      3EF-3樓,高慧雯,無車位
      2A-2樓,許郅玫,無車位
      2B-2樓,湯蕙如,無車位
      2C-2樓,黃翎鈞,無車位
      2D-2樓,郭純純,無車位
      2E-2樓,林梓聖,無車位
      2F-2樓,魏慶龍,無車位
      1A-1樓,之餘國際室內裝修工程有限公司,B2/11
      1B-1樓,之餘國際室內裝修工程有限公司,B2-12
      `;

      // --- DOM 元素 ---
      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');
      const titleEl = document.getElementById('dashboardTitle');
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const parkingSpots = document.querySelectorAll('.spot');

      // --- 應用程式邏輯 ---
      let db, auth, userId;
      let residentParkingMap = new Map();

      // 解析住戶車位資料，只在啟動時執行一次
      function parseResidentData() {
        const lines = residentParkingCsvData.split(/\r?\n/).slice(1).filter(line => line.trim() !== '');
        lines.forEach(line => {
          const [huBei, , carSpot] = line.split(',').map(item => item.trim());
          if (huBei && carSpot && carSpot !== '無車位') {
            residentParkingMap.set(huBei, carSpot);
          }
        });
      }

      // 更新畫面的函式 (核心)
      function renderParking(records) {
        const occupiedCount = records.length;
        const availableCount = TOTAL_SPOTS - occupiedCount;
        
        // 更新主標題
        titleEl.textContent = `臨停車位儀表板 (尚有 ${availableCount} 空位)`;
        
        // 更新最後更新時間
        const now = new Date();
        lastUpdatedEl.textContent = `最後更新: ${now.toLocaleTimeString('zh-TW')}`;

        parkingSpots.forEach((spotDiv, index) => {
          const spotNumber = index + 1;
          const innerDiv = spotDiv.querySelector('.spot-inner');
          let newClassName = 'spot ';
          let newHtml = '';

          if (spotNumber <= occupiedCount) {
            // 已停車
            const car = records[index];
            const isConstruction = car.huBei && car.huBei.includes('施工');
            const isOwnerWithSpot = residentParkingMap.has(car.huBei);

            if (isConstruction) {
              newClassName += 'status-occupied-construction';
            } else if (isOwnerWithSpot) {
              newClassName += 'status-occupied-owner';
            } else {
              newClassName += 'status-occupied-temp';
            }
            
            newHtml = `<div class="spot-number">${String(spotNumber).padStart(2, '0')}</div>
                       <div class="spot-status">已停車</div>
                       <div class="car-info">${car.carPlate || ''}<br>${car.huBei || ''}</div>`;
          } else {
            // 可停車
            newClassName += 'status-available';
            newHtml = `<div class="spot-number">${String(spotNumber).padStart(2, '0')}</div>
                       <div class="spot-status">可停</div>`;
          }

          // 只在需要時更新 DOM
          if (spotDiv.className !== newClassName) {
            spotDiv.className = newClassName;
          }
          if (innerDiv.innerHTML !== newHtml) {
            innerDiv.innerHTML = newHtml;
          }
          
          // 觸發刷新動畫
          spotDiv.classList.add('refreshing');
          setTimeout(() => spotDiv.classList.remove('refreshing'), 800);
        });

        // 顯示內容
        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
      }

      // 初始化 Firebase
      async function initializeAppAndAuth() {
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              setupRealtimeListener();
            } else {
              console.error('Firebase: 使用者未登入。');
              loadingDiv.textContent = '錯誤：無法驗證使用者身份，請重新載入頁面。';
            }
          });
        } catch (e) {
          console.error("Firebase 初始化失敗:", e);
          loadingDiv.textContent = `錯誤：無法連接至伺服器。(${e.message})`;
        }
      }

      // 設定即時資料監聽
      function setupRealtimeListener() {
        try {
          const collectionRef = collection(db, collectionPath);
          // *** FIX: 移除 orderBy，改為在客戶端排序，以避免需要複合索引 ***
          const q = query(collectionRef, where("leaveTime", "==", null));

          onSnapshot(q, (snapshot) => {
            let records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // 在客戶端手動排序
            records.sort((a, b) => {
              const timeA = a.entryTime?.seconds || 0;
              const timeB = b.entryTime?.seconds || 0;
              return timeA - timeB;
            });
            
            renderParking(records);
          }, (error) => {
            console.error("Firestore 資料監聽失敗:", error);
            loadingDiv.textContent = '錯誤：無法即時同步資料。';
          });
        } catch (e) {
          console.error("設定 Firestore 監聽器失敗:", e);
          loadingDiv.textContent = '錯誤：無法設定資料監聽。';
        }
      }

      // --- 程式啟動點 ---
      parseResidentData();
      initializeAppAndAuth();
    });
  </script>
</body>
</html>