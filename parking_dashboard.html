<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 臨時停車位即時狀態</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1.25rem;
      width: 95%;
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .spot {
      position: relative;
      padding-top: 100%; /* Maintain 1:1 ratio */
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease-in-out;
      cursor: default;
    }
    
    .spot:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .spot-inner {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      padding: 0.5rem;
      text-align: center;
      transition: background 0.5s ease;
    }
    
    .spot-number {
        font-size: clamp(1.8rem, 8vw, 2.5rem);
        font-weight: bold;
    }

    /* Status gradients and animations */
    .status-available { 
      background: linear-gradient(45deg, #66bb6a, #43a047); 
    }
    .status-occupied-owner { /* Owner with parking space */
      background: linear-gradient(45deg, #42a5f5, #1e88e5); 
    }
    .status-occupied-temp { /* Visitor/Owner without space */
      background: linear-gradient(45deg, #ef5350, #d32f2f); 
      animation: occupiedPulse 2.5s infinite ease-in-out;
    }
    .status-occupied-construction { /* Construction */
      background: linear-gradient(45deg, #ffca28, #ffb300);
    }
    .status-occupied-vip { /* VIP Guest */
      background: linear-gradient(45deg, #a78bfa, #8b5cf6);
    }
    
    @keyframes occupiedPulse {
        0%, 100% { box-shadow: 0 4px 15px rgba(239, 83, 80, 0.2); }
        50% { box-shadow: 0 8px 25px rgba(239, 83, 80, 0.4); }
    }

    .spot.refreshing {
        animation: spotRefresh 0.8s ease-in-out;
    }
    @keyframes spotRefresh {
        0% { transform: scale(1); }
        50% { transform: scale(1.05) rotate(3deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    .spot-status {
      font-size: clamp(0.75rem, 3vw, 0.9rem);
      font-weight: normal;
      margin-top: 0.25rem;
    }
    .car-info {
        font-size: clamp(0.8rem, 3.5vw, 1rem);
        font-weight: bold;
        margin-top: 0.25rem;
        line-height: 1.3;
        width: 100%;
    }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4">
    <div class="text-center my-4">
      <h1 id="dashboardTitle" class="text-2xl sm:text-3xl font-bold text-gray-800">佳元松江社區 臨停車位儀表板</h1>
      <p id="lastUpdated" class="text-sm sm:text-base text-gray-500 mt-2">-</p>
    </div>
    
    <div id="loading" class="text-center text-gray-500 mt-20">
      <div class="flex flex-col items-center justify-center">
        <svg class="animate-spin h-8 w-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="mt-4">正在從雲端同步資料...</span>
      </div>
    </div>

    <div id="content" class="hidden">
      <div class="grid" id="parkingGrid">
        <!-- Parking spots will be dynamically generated here -->
      </div>
    </div>
  </div>
  <footer class="text-center text-gray-500 text-sm my-8">
    © 佳元松江-管理中心 2025
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
          apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
          authDomain: "jy-2025.firebaseapp.com",
          projectId: "jy-2025",
          storageBucket: "jy-2025.appspot.com",
          messagingSenderId: "640527461851",
          appId: "1:640527461851:web:eed9f82d698275371fcbfe",
      };
      
      const TOTAL_SPOTS = 7;

      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');
      const titleEl = document.getElementById('dashboardTitle');
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const parkingGrid = document.getElementById('parkingGrid');

      let db, auth;

      // ##### NEW: Function to safely convert timestamp or string to Date object #####
      function parseTimestamp(timestamp) {
        if (!timestamp) return null;
        if (typeof timestamp.toDate === 'function') {
          return timestamp.toDate(); // It's a Firestore Timestamp
        }
        return new Date(timestamp); // It's likely an ISO string
      }

      function renderParking(records) {
        const occupiedCount = records.length;
        const availableCount = TOTAL_SPOTS - occupiedCount;
        
        titleEl.textContent = `臨停車位儀表板 (尚有 ${availableCount} 空位)`;
        const now = new Date();
        lastUpdatedEl.textContent = `最後更新: ${now.toLocaleTimeString('zh-TW')}`;
        
        parkingGrid.innerHTML = ''; // Clear previous spots

        for (let i = 1; i <= TOTAL_SPOTS; i++) {
            const spotDiv = document.createElement('div');
            const innerDiv = document.createElement('div');
            spotDiv.className = 'spot';
            innerDiv.className = 'spot-inner';
            spotDiv.appendChild(innerDiv);
            
            let newClassName = 'spot ';
            let newHtml = '';

            if (i <= occupiedCount) {
                const car = records[i - 1];
                const huBeiUpper = car.unit ? car.unit.toUpperCase() : '';
                const isConstruction = huBeiUpper.includes('施工');
                const isVip = huBeiUpper === '貴賓' || huBeiUpper === 'VIP';
                const isOwnerWithSpot = !!car.spotNumber; // Check if spotNumber exists

                if (isVip) {
                    newClassName += 'status-occupied-vip';
                } else if (isConstruction) {
                    newClassName += 'status-occupied-construction';
                } else if (isOwnerWithSpot) {
                    newClassName += 'status-occupied-owner';
                } else {
                    newClassName += 'status-occupied-temp';
                }
                
                newHtml = `<div class="spot-number">${String(i).padStart(2, '0')}</div>
                           <div class="spot-status">已停車</div>
                           <div class="car-info">${car.licensePlate || ''}<br>${car.unit || ''}</div>`;
            } else {
                newClassName += 'status-available';
                newHtml = `<div class="spot-number">${String(i).padStart(2, '0')}</div>
                           <div class="spot-status">可停</div>`;
            }

            spotDiv.className = newClassName;
            innerDiv.innerHTML = newHtml;
            parkingGrid.appendChild(spotDiv);

            // Add refresh animation
            spotDiv.classList.add('refreshing');
            setTimeout(() => spotDiv.classList.remove('refreshing'), 800);
        }

        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
      }

      async function initializeAppAndAuth() {
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          await signInAnonymously(auth);
          setupRealtimeListener();
        } catch (e) {
          console.error("Firebase initialization failed:", e);
          loadingDiv.innerHTML = '<p class="text-red-500">無法連接至伺服器。</p>';
        }
      }

      function setupRealtimeListener() {
        try {
          // ##### MODIFIED: Corrected collection path and query #####
          const collectionRef = collection(db, "parking_records");
          const q = query(collectionRef, where("status", "==", "present"));

          onSnapshot(q, (snapshot) => {
            let records = snapshot.docs
              .map(doc => ({ id: doc.id, ...doc.data() }));
            
            records.sort((a, b) => {
                const timeA = a.entryTime ? (a.entryTime.seconds || 0) : 0;
                const timeB = b.entryTime ? (b.entryTime.seconds || 0) : 0;
                return timeA - timeB;
            });
            
            renderParking(records);
          }, (error) => {
            console.error("Firestore data listener failed:", error);
            loadingDiv.innerHTML = '<p class="text-red-500">讀取資料失敗，請檢查網路或資料庫設定。</p>';
          });
        } catch (e) {
          console.error("Failed to set up Firestore listener:", e);
        }
      }

      initializeAppAndAuth();
    });
  </script>
</body>
</html>
